<!DOCTYPE html>
<html>

<head>
<title>Home IoT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
<h3 id="url" style="background-color: silver; border: 1px solid black;"></h3>
<h1>Home IoT</h1>
<table>
   <tr>
      <td style="font-weight: bold;">Room Temperature</td>
      <td><span id="temp"></span></td>
   </tr>
   <tr>
      <td style="font-weight: bold;">Room Humidity</td>
      <td><span id="humidity"></span></td>
   </tr>
</table>

<div style="margin-top:20px;">
   <label><input type="checkbox" id="light"> LED</label>
</div>
<div style="margin-top:20px;">
   <button id="stat" style="padding: 7px;">Check PI Health</button>
</div>

<div style="background-color:black; border:inset black; bottom:0; color: whitesmoke; height: 30vh; padding: 5px; position:fixed; overflow-y: auto; width:100%;">
   <pre id="notify"></pre>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
<script>
	document.querySelector('#url').innerHTML = window.location.href;

	var socket = io(); //load socket.io-client and connect to the host that serves the page

	window.addEventListener("load", function () { //when page loads
		var lightbox = document.getElementById("light");

		lightbox.addEventListener("change", function () { //add event listener for when checkbox changes
   		console.log('"change" event fired with val:', this.checked);
   		socket.emit("light", { from: 'browser', val: this.checked }); //send button status to server (as 1 or 0)
		});
	});

	socket.on('light', function (data) { //get button status from client
		document.getElementById("light").checked = data.val; //change checkbox according to push button on Raspberry Pi
		console.log('message from "light". data:', data);
		if(data.to != 'connectee')
			notify('Led state changed.');
	});

   socket.on('humiture', function (data) { //get button status from client
      if('val' in data) {
         document.getElementById("temp").innerHTML = '...'
         document.getElementById("humidity").innerHTML = '...'
         setTimeout(() => {
      		document.getElementById("temp").innerHTML = data.val.temperature
            document.getElementById("humidity").innerHTML = data.val.humidity
         }, 300);
      }
      else {
         notify(`Error occurred from Humiture event.<br>[${data.error.toString()}]`);
      }
	});

   document.querySelector('#stat')
      .addEventListener('click', () => socket.emit("pi-stat", { from: 'browser' }))
   socket.on('pi-stat', function (data) {
      notify(data.val || data.error.toString())
   })

	function notify(msg) {
      let notifyElem = document.querySelector('#notify');
      notifyElem.innerHTML = msg + '\n' + notifyElem.innerHTML;
	}
</script>
</body>

</html>
