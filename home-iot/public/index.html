<!DOCTYPE html>
<html>
<head>
   <title>Home IoT</title>
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <style>
      th, td {
         border-top: 1px solid black;
      }
       th {
         text-align: left;
         vertical-align: top;
      }
      button {
         margin: 4px;
         padding: 8px;
      }
   </style>
</head>
<body>
   <main style="margin-bottom:20px;">
      <h3 id="url" style="background-color: silver; border: 1px solid black;"></h3>
      <h1>Home IoT</h1>
      <table>
         <tr>
            <th>Thermistor</th>
            <td><span id="thermistor"></span></td>
         </tr>
         <tr>
            <th>Photoresistor</th>
            <td><span id="photoresistor"></span> (<span id="photoresistorStatus"></span>)</td>
         </tr>
         <tr>
            <th>Temperature<br>(Humiture)</th>
            <td><span id="temp"></span></td>
         </tr>
         <tr>
            <th>Humidity<br>(Humiture)</th>
            <td><span id="humidity"></span></td>
         </tr>
         <tr>
            <th>Live Connections</th>
            <td><span id="connectionCount"></span></td>
         </tr>
         <tr>
            <th><i>Last checked</i></th>
            <td><i id="last-checked"></i></td>
         </tr>
         <tr>
            <th>Pi Health Data</th>
            <td>
               <div style="overflow: auto; width: 60vw;">
                  <pre id="pi-health-data"></pre>
               </div>
            </td>
         </tr>
         <tr>
            <th>Actions</th>
            <td>
               <button type="button" id="terminate-app">Terminate Node App</button>
               <button type="button" id="reboot">Reboot Raspberry Pi</button>
               <button type="button" id="poweroff">Poweroff Raspberry Pi</button>
            </td>
         </tr>
      </table>

      <div style="display: none; margin-top:20px;">
         <label><input type="checkbox" id="light" style="height: 20px; width: 20px;"> LED</label>
      </div>
      <div style="margin-top:20px;">
         <button id="stat" style="padding: 7px;">Check PI Health</button>
      </div>
   </main>

   <div style="background-color:black; border:inset black; bottom:0; color: whitesmoke; padding: 5px; overflow: auto;">
      <pre id="notify"></pre>
   </div>

   <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
   <script>
   	document.querySelector('#url').innerHTML = window.location.href;

   	var socket = io(); //load socket.io-client and connect to the host that serves the page

   	window.addEventListener("load", function () { //when page loads
   		var lightCheckbox = document.getElementById("light");

   		lightCheckbox.addEventListener("change", function () { //add event listener for when checkbox changes
      		//console.log('"change" event fired with val:', this.checked);
      		socket.emit("light", { from: 'browser', val: this.checked }); //send button status to server (as 1 or 0)
   		});
   	});

   	socket.on('light', function (data) { //get button status from client
   		document.getElementById("light").checked = data.val; //change checkbox according to push button on Raspberry Pi
   		//console.log('message from "light". data:', data);
   		if(data.to != 'connectee')
   			notify('Led state changed.');
   	});

      socket.on('periodic-data', function (data) { //get button status from client
         if('val' in data) {
            document.getElementById("thermistor").innerHTML = data.val.thermistor.toFixed(2);
            document.getElementById("photoresistor").innerHTML = data.val.photoresistor.toFixed(2);
            document.getElementById("photoresistorStatus").innerHTML = data.val.photoresistorStatus;
      		document.getElementById("temp").innerHTML = data.val.temperature;
            document.getElementById("humidity").innerHTML = data.val.humidity;
            document.getElementById("pi-health-data").innerHTML = data.val.piHealthData;
            document.getElementById("last-checked").innerHTML = data.time;
            document.getElementById("connectionCount").innerHTML = data.connectionCount;
         }
         
         if(!data.success) {
            notify(`Error occurred on periodic-data hook. [Error: ${JSON.stringify(data.errors)}]`);
         }
   	});

      document.querySelector('#stat')
         .addEventListener('click', () => socket.emit("pi-stat", { from: 'browser' }))

      socket.on('pi-stat', function (data) {
         notify(data.val.piHealthData || JSON.stringify(data.error))
      })

      document
         .querySelector('#terminate-app')
         .addEventListener('click', () => {
            if(confirm('Confirm?')) {
               socket.emit("terminate-app", { from: 'browser' })
               turnOffApp();
            }
         });

         document
            .querySelector('#reboot')
            .addEventListener('click', () => {
               if(confirm('Confirm?')) {
                  socket.emit("reboot", { from: 'browser' });
                  turnOffApp();
               }
            });

         document
            .querySelector('#poweroff')
            .addEventListener('click', () => {
               if(confirm('Confirm?')) {
                  socket.emit("poweroff", { from: 'browser' });
                  turnOffApp();
               }
            });
      
      function turnOffApp() {
         setTimeout(() => { 
            document.body.innerHTML = '';
            document.body.style.backgroundColor = 'black'; }, 
         700);
      }

   	function notify(msg) {
         let notifyElem = document.querySelector('#notify');
         notifyElem.innerHTML = msg + '\n' + notifyElem.innerHTML;
   	}
   </script>
</body>
</html>
