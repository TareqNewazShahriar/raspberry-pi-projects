<!DOCTYPE html>
<html>
<head>
   <title>Home IoT</title>
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <style>
      th, td {
         border-top: 1px solid black;
      }
       th {
         text-align: left;
         vertical-align: top;
      }
      button {
         margin: 4px;
         padding: 8px;
      }
      input[type=checkbox],
      input[type=radio] {
         height: 20px;
         width: 20px;
      }
   </style>
</head>
<body>
   <main style="margin-bottom:20px;">
      <h3 id="url" style="background-color: silver; border: 1px solid black;"></h3>
      <h1>Home IoT</h1>
      <table>
         <tr>
            <th>Room Temperature</th>
            <td><span id="thermistor"></span></td>
         </tr>
         <tr>
            <th>Room Light Condition</th>
            <td>
               <span id="photoresistor"></span>
               <br>
               [Hint: <span id="photoresistorStatus"></span>]
            </td>
         </tr>
         <tr>
            <th>Bulb Control Mode</th>
            <td>
               <label><input type="radio" name="bulbControlMode" value="1"> Sensor</label>
               <label><input type="radio" name="bulbControlMode" value="2"> Manual</label>
            </td>
         </tr>
         <tr>
            <th>Bulb Status</th>
            <td>
               <label><input type="radio" name="bulbStatus" value="1" disabled> ON</label>
               <label><input type="radio" name="bulbStatus" value="0" disabled> OFF</label>
            </td>
         </tr>
         <tr>
            <th>
               Connected Clients<br>
               <span style="font-weight: normal;">(number of clients connected<br>to Raspberry PI over internet)</span>
            </th>
            <td><span id="connectionCount"></span></td>
         </tr>
         <tr>
            <th>Local Proxy Status</th>
            <td><span id="local-proxy-status"></span></td>
         </tr>
         <tr>
            <th><i>Last checked</i></th>
            <td><i id="last-checked"></i></td>
         </tr>
         <tr>
            <th>Pi Health Data</th>
            <td>
               <div style="overflow: auto; width: 60vw;">
                  <pre id="pi-health-data"></pre>
               </div>
            </td>
         </tr>
         <tr>
            <th>Actions</th>
            <td>
               <button type="button" id="stat">PI Health</button>
               <button type="button" id="terminate-app">Terminate Node App</button>
               <button type="button" id="reboot">Reboot Raspberry Pi</button>
               <button type="button" id="poweroff">Poweroff Raspberry Pi</button>
            </td>
         </tr>
      </table>
   </main>
   <footer style="background-color:black; border:inset black; bottom:0; color: whitesmoke; padding: 5px; overflow: auto;">
      <pre id="notify"></pre>
   </footer>

   <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
   <script>
   	document.querySelector('#url').innerHTML = window.location.href;

   	var socket = io(); //load socket.io-client and connect to the host that serves the page

      socket.on('connect', () => notify('Real-time communication established.'));

   	socket.on('bulb-control-mode', function (data) { //get button status from client
   		document.querySelector(`input[name="bulbControlMode"][value="${data.bulbControlMode}"]`).checked = true;
   	});

      socket.on('periodic-data', function (data) { //get button status from client
         if(data.thermistor.success)
            document.getElementById("thermistor").innerHTML = data.thermistor.value.toFixed(1);
         else
            notify(data.thermistor.error);

         if(data.photoresistor.success)
            document.getElementById("photoresistor").innerHTML = data.photoresistor.value;
         else
            notify(data.photoresistor.error);

         if(data.piHealthData.success)
            document.getElementById("pi-health-data").innerHTML = data.piHealthData.value;
         else
            notify(data.piHealthData.error);
         
         document.querySelector(`input[name="bulbStatus"][value="${data.bulbStatus}"]`).checked = true;
         document.querySelectorAll(`input[name="bulbStatus"]`).forEach(x => x.disabled = data.bulbControlMode == 1);
         document.querySelector(`input[name="bulbControlMode"][value="${data.bulbControlMode}"]`).checked = true;
         document.getElementById("photoresistorStatus").innerHTML = data.photoresistorStatus;
         document.getElementById("connectionCount").innerHTML = data.connectionCount;
         document.querySelector('#local-proxy-status').innerHTML = data.localProxyStatus;
         document.getElementById("last-checked").innerHTML = data.time;
   	});

      document
         .querySelectorAll('input[name=bulbControlMode]')
         .forEach(radio => {
            radio.addEventListener('click', (event) => {
               if(confirm('Confirm?')) {
                  socket.emit("bulb-control-mode", { from: 'browser', value: parseInt(event.target.value) });
                  document.querySelectorAll(`input[name="bulbStatus"]`).forEach(x => x.disabled = event.target.value == 1);
               }
               else {
                  event.preventDefault();
                  return false;
               }
            });
         });

         document
            .querySelectorAll('input[name=bulbStatus]')
            .forEach(radio => {
               radio.addEventListener('click', (event) => {
                  if(confirm('Confirm?')) {
                     socket.emit("bulb-status", { from: 'browser', value: parseInt(event.target.value) });
                  }
                  else {
                     event.preventDefault();
                     return false;
                  }
               });
            });

      document
         .querySelector('#stat')
         .addEventListener('click', () => socket.emit("pi-stat", { from: 'browser' }))

      socket.on('pi-stat', function (data) {
         notify(data.piHealthData.value || data.piHealthData.error)
      })

      document
         .querySelector('#terminate-app')
         .addEventListener('click', () => {
            if(confirm('Terminate the web app?')) {
               socket.emit("terminate-app", { from: 'browser' })
               turnOffApp();
            }
         });

         document
            .querySelector('#reboot')
            .addEventListener('click', () => {
               if(confirm('Reboot the Raspberry PI?')) {
                  socket.emit("reboot", { from: 'browser' });
                  turnOffApp();
               }
            });

         document
            .querySelector('#poweroff')
            .addEventListener('click', () => {
               if(confirm('Shut down the Raspberry PI?')) {
                  socket.emit("poweroff", { from: 'browser' });
                  turnOffApp();
               }
            });
      
      function turnOffApp() {
         setTimeout(() => { 
            socket.disconnect();
            document.body.innerHTML = '';
            document.body.style.backgroundColor = 'black'; 
         },
         700);
      }

   	function notify(msg) {
         let notifyElem = document.querySelector('#notify');
         notifyElem.innerHTML = `[${new Date().toISOString()}]\n${msg}\n\n${notifyElem.innerHTML}`; }
   </script>
</body>
</html>
