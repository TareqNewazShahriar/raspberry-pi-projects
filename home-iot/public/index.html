<!DOCTYPE html>
<html>
<head>
   <title>Home IoT</title>
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <style>
      th, td {
         border-top: 1px solid black;
      }
       th {
         text-align: left;
         vertical-align: top;
      }
      button {
         margin: 4px;
         padding: 8px;
      }
      input[type=checkbox],
      input[type=radio] {
         height: 20px;
         width: 20px;
      }
   </style>
</head>
<body>
   <main style="margin-bottom:20px;">
      <h3 id="url" style="background-color: silver; border: 1px solid black;"></h3>
      <h1>Home IoT</h1>
      <table>
         <tr>
            <th>Room Light Condition</th>
            <td>
               <span id="photoresistorStatus"></span> &nbsp;
               <span id="photoresistor"></span></td>
         </tr>
         <tr>
            <th>Light Control Mode</th>
            <td>
               <label><input type="radio" name="bulbControlMode" value="1"> Sensor</label>
               <label><input type="radio" name="bulbControlMode" value="2"> Manual</label>
            </td>
         </tr>
         <tr>
            <th>Room Temperature</th>
            <td><span id="thermistor"></span></td>
         </tr>
         <tr>
            <th>
               Live Connections<br>
               <span style="font-weight: normal;">(number of clients connected to Raspberry PI over internet)</span>
            </th>
            <td><span id="connectionCount"></span></td>
         </tr>
         <tr>
            <th><i>Last checked</i></th>
            <td><i id="last-checked"></i></td>
         </tr>
         <tr>
            <th>Pi Health Data</th>
            <td>
               <div style="overflow: auto; width: 60vw;">
                  <pre id="pi-health-data"></pre>
               </div>
            </td>
         </tr>
         <tr>
            <th>Actions</th>
            <td>
               <button type="button" id="stat">PI Health</button>
               <button type="button" id="terminate-app">Terminate Node App</button>
               <button type="button" id="reboot">Reboot Raspberry Pi</button>
               <button type="button" id="poweroff">Poweroff Raspberry Pi</button>
            </td>
         </tr>
      </table>
   </main>
   <footer style="background-color:black; border:inset black; bottom:0; color: whitesmoke; padding: 5px; overflow: auto;">
      <pre id="notify"></pre>
   </footer>

   <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
   <script>
   	document.querySelector('#url').innerHTML = window.location.href;

   	var socket = io(); //load socket.io-client and connect to the host that serves the page

      socket.on('connect', () => notify('Real-time communication established.'));

   	socket.on('bulb-control-mode', function (data) { //get button status from client
   		document.querySelector(`input[name=bulbControlMode][value=${data.val}]`).checked = true;
   	});

      socket.on('periodic-data', function (data) { //get button status from client
         if('val' in data) {
            document.getElementById("thermistor").innerHTML = data.val.thermistor.toFixed(2);
            document.getElementById("photoresistor").innerHTML = data.val.photoresistor.toFixed(2);
            document.getElementById("photoresistorStatus").innerHTML = data.val.photoresistorStatus;
      		document.getElementById("pi-health-data").innerHTML = data.val.piHealthData;
            document.getElementById("last-checked").innerHTML = data.time;
            document.getElementById("connectionCount").innerHTML = data.connectionCount;
         }
         
         if(!data.success) {
            notify(`Error occurred on periodic-data hook. [Error: ${JSON.stringify(data.errors)}]`);
         }
   	});

      document
         .querySelectorAll('input[name=bulbControlMode]')
         .forEach(radio => {
            radio.addEventListener('change', (event) => {
               if(confirm('Confirm?')) {
                  socket.emit("bulb-control-mode", { from: 'browser', val: event.target.value });
               }
            });
         });

      document
         .querySelector('#stat')
         .addEventListener('click', () => socket.emit("pi-stat", { from: 'browser' }))

      socket.on('pi-stat', function (data) {
         notify(data.val.piHealthData || JSON.stringify(data.error))
      })

      document
         .querySelector('#terminate-app')
         .addEventListener('click', () => {
            if(confirm('Confirm?')) {
               socket.emit("terminate-app", { from: 'browser' })
               turnOffApp();
            }
         });

         document
            .querySelector('#reboot')
            .addEventListener('click', () => {
               if(confirm('Confirm?')) {
                  socket.emit("reboot", { from: 'browser' });
                  turnOffApp();
               }
            });

         document
            .querySelector('#poweroff')
            .addEventListener('click', () => {
               if(confirm('Confirm?')) {
                  socket.emit("poweroff", { from: 'browser' });
                  turnOffApp();
               }
            });
      
      function turnOffApp() {
         setTimeout(() => { 
            document.body.innerHTML = '';
            document.body.style.backgroundColor = 'black'; 
         },
         700);
      }

   	function notify(msg) {
         let notifyElem = document.querySelector('#notify');
         notifyElem.innerHTML = msg + '\n' + notifyElem.innerHTML;
   	}
   </script>
</body>
</html>
